From 98dbef90eb29b13079ba3bd260b3c5818904ee86 Mon Sep 17 00:00:00 2001
From: Fujii Masao <fujii@postgresql.org>
Date: Wed, 8 Sep 2021 16:28:43 +0900
Subject: [PATCH] postgres_fdw: Revert unstable tests for
 postgres_fdw.application_name.

Commit 449ab63505 added the tests that check that postgres_fdw.application_name
GUC works as expected. But they were unstable and caused some buildfarm
members to report the failure. This commit reverts those unstable tests.

Reported-by: Tom Lane as per buildfarm
Discussion: https://postgr.es/m/3220909.1631054766@sss.pgh.pa.us
---
 .../postgres_fdw/expected/postgres_fdw.out    | 79 -------------------
 contrib/postgres_fdw/sql/postgres_fdw.sql     | 39 ---------
 2 files changed, 118 deletions(-)

diff --git a/contrib/postgres_fdw/expected/postgres_fdw.out b/contrib/postgres_fdw/expected/postgres_fdw.out
index 39befa394ad4..e3ee30f1aaf3 100644
--- a/contrib/postgres_fdw/expected/postgres_fdw.out
+++ b/contrib/postgres_fdw/expected/postgres_fdw.out
@@ -10761,82 +10761,3 @@ ERROR:  invalid value for integer option "fetch_size": 100$%$#$#
 CREATE FOREIGN TABLE inv_bsz (c1 int )
 	SERVER loopback OPTIONS (batch_size '100$%$#$#');
 ERROR:  invalid value for integer option "batch_size": 100$%$#$#
--- ===================================================================
--- test postgres_fdw.application_name GUC
--- ===================================================================
--- Turn debug_discard_caches off for this test to make that
--- the remote connection is alive when checking its application_name.
--- For each test, close all the existing cached connections manually and
--- establish connection with new setting of application_name.
-SET debug_discard_caches = 0;
--- If appname is set as GUC but not as options of server object,
--- the GUC setting is used as application_name of remote connection.
-SET postgres_fdw.application_name TO 'fdw_guc_appname';
-SELECT 1 FROM postgres_fdw_disconnect_all();
- ?column? 
-----------
-        1
-(1 row)
-
-SELECT 1 FROM ft6 LIMIT 1;
- ?column? 
-----------
-        1
-(1 row)
-
-SELECT application_name FROM pg_stat_activity
-       WHERE application_name IN ('loopback2', 'fdw_guc_appname');
- application_name 
-------------------
- fdw_guc_appname
-(1 row)
-
--- If appname is set as options of server object but not as GUC,
--- appname of server object is used.
-RESET postgres_fdw.application_name;
-ALTER SERVER loopback2 OPTIONS (ADD application_name 'loopback2');
-SELECT 1 FROM postgres_fdw_disconnect_all();
- ?column? 
-----------
-        1
-(1 row)
-
-SELECT 1 FROM ft6 LIMIT 1;
- ?column? 
-----------
-        1
-(1 row)
-
-SELECT application_name FROM pg_stat_activity
-       WHERE application_name IN ('loopback2', 'fdw_guc_appname');
- application_name 
-------------------
- loopback2
-(1 row)
-
--- If appname is set both as GUC and as options of server object,
--- the GUC setting overrides appname of server object and is used.
-SET postgres_fdw.application_name TO 'fdw_guc_appname';
-SELECT 1 FROM postgres_fdw_disconnect_all();
- ?column? 
-----------
-        1
-(1 row)
-
-SELECT 1 FROM ft6 LIMIT 1;
- ?column? 
-----------
-        1
-(1 row)
-
-SELECT application_name FROM pg_stat_activity
-       WHERE application_name IN ('loopback2', 'fdw_guc_appname');
- application_name 
-------------------
- fdw_guc_appname
-(1 row)
-
---Clean up
-ALTER SERVER loopback2 OPTIONS (DROP application_name);
-RESET postgres_fdw.application_name;
-RESET debug_discard_caches;
diff --git a/contrib/postgres_fdw/sql/postgres_fdw.sql b/contrib/postgres_fdw/sql/postgres_fdw.sql
index 20749868d31f..30b5175da5b2 100644
--- a/contrib/postgres_fdw/sql/postgres_fdw.sql
+++ b/contrib/postgres_fdw/sql/postgres_fdw.sql
@@ -3422,42 +3422,3 @@ CREATE FOREIGN TABLE inv_fsz (c1 int )
 -- Invalid batch_size option
 CREATE FOREIGN TABLE inv_bsz (c1 int )
 	SERVER loopback OPTIONS (batch_size '100$%$#$#');
-
--- ===================================================================
--- test postgres_fdw.application_name GUC
--- ===================================================================
--- Turn debug_discard_caches off for this test to make that
--- the remote connection is alive when checking its application_name.
--- For each test, close all the existing cached connections manually and
--- establish connection with new setting of application_name.
-SET debug_discard_caches = 0;
-
--- If appname is set as GUC but not as options of server object,
--- the GUC setting is used as application_name of remote connection.
-SET postgres_fdw.application_name TO 'fdw_guc_appname';
-SELECT 1 FROM postgres_fdw_disconnect_all();
-SELECT 1 FROM ft6 LIMIT 1;
-SELECT application_name FROM pg_stat_activity
-       WHERE application_name IN ('loopback2', 'fdw_guc_appname');
-
--- If appname is set as options of server object but not as GUC,
--- appname of server object is used.
-RESET postgres_fdw.application_name;
-ALTER SERVER loopback2 OPTIONS (ADD application_name 'loopback2');
-SELECT 1 FROM postgres_fdw_disconnect_all();
-SELECT 1 FROM ft6 LIMIT 1;
-SELECT application_name FROM pg_stat_activity
-       WHERE application_name IN ('loopback2', 'fdw_guc_appname');
-
--- If appname is set both as GUC and as options of server object,
--- the GUC setting overrides appname of server object and is used.
-SET postgres_fdw.application_name TO 'fdw_guc_appname';
-SELECT 1 FROM postgres_fdw_disconnect_all();
-SELECT 1 FROM ft6 LIMIT 1;
-SELECT application_name FROM pg_stat_activity
-       WHERE application_name IN ('loopback2', 'fdw_guc_appname');
-
---Clean up
-ALTER SERVER loopback2 OPTIONS (DROP application_name);
-RESET postgres_fdw.application_name;
-RESET debug_discard_caches;
