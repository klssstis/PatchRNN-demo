From 777e6ddf1723306bd2bf8fe6f804863f459b0323 Mon Sep 17 00:00:00 2001
From: Bruce Momjian <bruce@momjian.us>
Date: Tue, 14 Aug 2018 17:19:02 -0400
Subject: [PATCH] pg_upgrade:  fix shutdown check for standby servers

Commit 244142d32afd02e7408a2ef1f249b00393983822 only tested for the
pg_controldata output for primary servers, but standby servers have
different "Database cluster state" output, so check for that too.

Diagnosed-by: Michael Paquier

Discussion: https://postgr.es/m/20180810164240.GM13638@paquier.xyz

Backpatch-through: 9.3
---
 src/bin/pg_upgrade/controldata.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/bin/pg_upgrade/controldata.c b/src/bin/pg_upgrade/controldata.c
index ce3f263b107c..f2f3ac55e78e 100644
--- a/src/bin/pg_upgrade/controldata.c
+++ b/src/bin/pg_upgrade/controldata.c
@@ -150,7 +150,8 @@ get_control_data(ClusterInfo *cluster, bool live_check)
 				/* remove leading spaces */
 				while (*p == ' ')
 					p++;
-				if (strcmp(p, "shut down\n") != 0)
+				if (strcmp(p, "shut down\n") != 0 &&
+					strcmp(p, "shut down in recovery\n") != 0)
 				{
 					if (cluster == &old_cluster)
 						pg_fatal("The source cluster was not shut down cleanly.\n");
