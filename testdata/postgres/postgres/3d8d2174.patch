From 3d8d217450a63638825167c17ed791122f376176 Mon Sep 17 00:00:00 2001
From: Andres Freund <andres@anarazel.de>
Date: Sat, 12 Aug 2023 13:09:45 -0700
Subject: [PATCH] ci: macos: Remove use of -Dsegsize_blocks=6

The option causes a measurable slowdown. Macos is, by far, the most expensive
platform for CI, therefore it doesn't make sense to run such a test there.

d3b111e3205 used a small segment size for two tasks, one with autoconf, one
with meson. In hindsight that is a bit overkill, it's unlikely that the option
would silently break. Thus don't move the -Dsegsize_blocks=6, just remove
it. I did however change the autoconf test to use 6 instead of 8 blocks, as
long as we allow it, a non-power-of-two test seems like a good idea.

While at it, add a comment explaining why we use a small segment size for CI.

Author: Andres Freund <andres@anarazel.de>
Reviewed-by: Heikki Linnakangas <hlinnaka@iki.fi>
Discussion: https://postgr.es/m/20230808021541.7lbzdefvma7qmn3w@awork3.anarazel.de
Backpatch: 16-, where d3b111e3205 introduced the use of -Dsegsize_blocks=6
---
 .cirrus.yml | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/.cirrus.yml b/.cirrus.yml
index b742aaf6863d..314ae2d804bc 100644
--- a/.cirrus.yml
+++ b/.cirrus.yml
@@ -331,12 +331,18 @@ task:
       env:
         SANITIZER_FLAGS: -fsanitize=address
 
+      # Normally, the "relation segment" code basically has no coverage in our
+      # tests, because we (quite reasonably) don't generate tables large
+      # enough in tests. We've had plenty bugs that we didn't notice due the
+      # code not being exercised much. Thus specify a very small segment size
+      # here. Use a non-power-of-two segment size, given we currently allow
+      # that.
       configure_script: |
         su postgres <<-EOF
           ./configure \
             --enable-cassert --enable-debug --enable-tap-tests \
             --enable-nls \
-            --with-segsize-blocks=8 \
+            --with-segsize-blocks=6 \
             \
             ${LINUX_CONFIGURE_FEATURES} \
             \
@@ -504,7 +510,6 @@ task:
       -Dextra_lib_dirs=${brewpath}/lib \
       -Dcassert=true \
       -Duuid=e2fs -Ddtrace=auto \
-      -Dsegsize_blocks=6 \
       -DPG_TEST_EXTRA="$PG_TEST_EXTRA" \
       build
 
