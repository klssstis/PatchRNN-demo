From 81a6d57e33515958203938cb686bf0c255255cff Mon Sep 17 00:00:00 2001
From: Jeff Davis <jdavis@postgresql.org>
Date: Sat, 25 Mar 2023 11:08:32 -0700
Subject: [PATCH] Fix abbreviated keys bug introduced in d87d548cd03.

Discussion: http://postgr.es/m/CAMkU=1z17XJatF-rMCY3Cjqcxer-Kyn57x6h3OSCpJ0LpAp0ig@mail.gmail.com
Reported-by: Jeff Janes
---
 src/backend/utils/adt/varlena.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/backend/utils/adt/varlena.c b/src/backend/utils/adt/varlena.c
index 5778e3f0efdf..f9a607adaff1 100644
--- a/src/backend/utils/adt/varlena.c
+++ b/src/backend/utils/adt/varlena.c
@@ -2329,6 +2329,7 @@ varstr_abbrev_convert(Datum original, SortSupport ssup)
 
 			bsize = pg_strxfrm_prefix(sss->buf2, sss->buf1,
 									  max_prefix_bytes, sss->locale);
+			sss->last_len2 = bsize;
 		}
 		else
 		{
